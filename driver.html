<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D Driver Mode (Robust)</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #000; font-family: 'Orbitron', sans-serif; overflow: hidden; width: 100vw; height: 100dvh; }

        .input_video { 
            position: absolute; width: 100%; height: 100%; 
            object-fit: cover; opacity: 0; z-index: 0; 
        }
        
        #canvas3d { position: absolute; top:0; left:0; width: 100%; height: 100%; z-index: 1; }

        model-viewer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5;
            background-color: transparent; pointer-events: auto; --poster-color: transparent;
        }

        .ui-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px; z-index: 10;
        }

        .header-glass {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px);
            padding: 15px 20px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.2);
            pointer-events: auto;
        }

        .back-btn {
            background: transparent; color: white; border: 1px solid white; padding: 8px 16px;
            border-radius: 20px; text-decoration: none; font-size: 0.8rem; display: flex; align-items: center; gap: 5px;
        }

        .shutter-btn {
            width: 70px; height: 70px; background: rgba(255,255,255,0.2); border-radius: 50%;
            border: 4px solid white; position: absolute; bottom: 40px; left: 50%;
            transform: translateX(-50%); pointer-events: auto; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        .shutter-inner { width: 54px; height: 54px; background: white; border-radius: 50%; transition: 0.1s; }
        .shutter-btn:active .shutter-inner { transform: scale(0.9); background: #ff0040; }

        #start-camera-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 50;
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; text-align: center;
        }
        #start-btn {
            padding: 15px 30px; background: #ff0040; color: white; border: none; border-radius: 30px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px rgba(255, 0, 64, 0.5);
        }
        #status-msg { color: #00ff88; font-size: 14px; margin-top: 20px; max-width: 80%; line-height: 1.5; }
        #error-msg { color: #ff3333; font-size: 14px; margin-top: 10px; display: none; max-width: 80%; }
    </style>
</head>
<body>

    <video class="input_video" playsinline webkit-playsinline></video>
    <canvas id="canvas3d"></canvas>

    <div id="start-camera-overlay">
        <h2 style="color:white;">Ø­Ø§Ù„Øª Ù¾Ø±Ùˆ Ù„Ø¨Ø§Ø³</h2>
        <p style="color:#bbb; font-size: 0.8rem; margin-bottom: 20px;">Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ø² Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯</p>
        <button id="start-btn" onclick="startExperience()">ğŸ“· ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†</button>
        <p id="status-msg"></p>
        <p id="error-msg"></p>
    </div>

    <div class="ui-overlay">
        <div class="header-glass">
            <a href="index.html" class="back-btn">â† Ø¨Ø§Ø²Ú¯Ø´Øª</a>
            <div style="color:#fff; font-weight:bold;">3D SUIT</div>
        </div>
        <div class="shutter-btn" onclick="takePhoto()"><div class="shutter-inner"></div></div>
    </div>

    <model-viewer 
        src="https://f1-ar-nine.vercel.app/assets/car.glb"
        alt="F1 Car"
        camera-controls disable-pan shadow-intensity="1" scale="0.05 0.05 0.05" 
        camera-orbit="45deg 75deg 4m" skybox-image="null" environment-image="neutral">
    </model-viewer>

    <script>
        // Ø¢Ø¯Ø±Ø³ Ù…Ø¯Ù„ Ø³Ù‡ Ø¨Ø¹Ø¯ÛŒ (Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ú©Ù†Ø§Ø± driver.html Ø¨Ø§Ø´Ø¯)
        const MODEL_URL = 'suit.glb'; 
        const BASE_SCALE = 20; 

        const videoElement = document.querySelector('.input_video');
        const canvas3d = document.getElementById('canvas3d');
        const startOverlay = document.getElementById('start-camera-overlay');
        const statusMsg = document.getElementById('status-msg');
        const errorMsg = document.getElementById('error-msg');
        
        // --- Three.js Init ---
        const scene = new THREE.Scene();
        const camera3d = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: canvas3d, alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(2, 5, 5);
        scene.add(dirLight);

        let videoTexture; 
        let suitModel = null;
        const loader = new THREE.GLTFLoader();
        
        // Ù„ÙˆØ¯ Ù…Ø¯Ù„
        loader.load(MODEL_URL, (gltf) => {
            suitModel = gltf.scene;
            suitModel.visible = false;
            scene.add(suitModel);
            console.log("Suit Model Loaded");
            statusMsg.innerText = "Ù…Ø¯Ù„ Ù„ÙˆØ¯ Ø´Ø¯. Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†...";
        }, undefined, (error) => {
            console.error(error);
            errorMsg.style.display = 'block';
            errorMsg.innerText = "âš ï¸ ÙØ§ÛŒÙ„ suit.glb Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯! Ù„Ø·ÙØ§ ÙØ§ÛŒÙ„ Ø±Ø§ Ø¯Ø± Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯.";
        });

        camera3d.position.z = 5;

        // --- MediaPipe Init ---
        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults((results) => {
            if(videoTexture) {
                videoTexture.needsUpdate = true;
                scene.background = videoTexture;
            }

            if (results.poseLandmarks && suitModel) {
                const leftShoulder = results.poseLandmarks[11];
                const rightShoulder = results.poseLandmarks[12];
                
                if(leftShoulder.visibility > 0.5 && rightShoulder.visibility > 0.5) {
                    suitModel.visible = true;
                    statusMsg.style.display = 'none';

                    const centerX = (leftShoulder.x + rightShoulder.x) / 2;
                    const centerY = (leftShoulder.y + rightShoulder.y) / 2;
                    
                    const x = (centerX - 0.5) * 2;
                    const y = -(centerY * 2 - 1);
                    
                    suitModel.position.set(x * 5, y * 3.5, 0); 
                    
                    const dist = Math.sqrt(Math.pow(rightShoulder.x - leftShoulder.x, 2) + Math.pow(rightShoulder.y - leftShoulder.y, 2));
                    const s = dist * BASE_SCALE; 
                    suitModel.scale.set(s, s, s);
                    
                    const angle = Math.atan2(rightShoulder.y - leftShoulder.y, rightShoulder.x - leftShoulder.x);
                    suitModel.rotation.z = -angle; 
                }
            }
            renderer.render(scene, camera3d);
        });

        // --- ØªØ§Ø¨Ø¹ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ† ---
        async function getCameraStream() {
            // ØªÙ„Ø§Ø´ Û±: Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ø´Øª Ø¨Ø§ Ú©ÛŒÙÛŒØª HD
            try {
                return await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false
                });
            } catch (e) { console.log("HD failed, trying SD..."); }

            // ØªÙ„Ø§Ø´ Û²: Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ø´Øª Ø¨Ø¯ÙˆÙ† Ú©ÛŒÙÛŒØª Ø®Ø§Øµ
            try {
                return await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });
            } catch (e) { console.log("Back camera failed, trying any camera..."); }

            // ØªÙ„Ø§Ø´ Û³: Ù‡Ø± Ø¯ÙˆØ±Ø¨ÛŒÙ†ÛŒ Ú©Ù‡ Ø´Ø¯
            try {
                return await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: false
                });
            } catch (e) {
                throw e; // Ø§Ú¯Ø± Ù‡ÛŒÚ†Ú©Ø¯Ø§Ù… Ù†Ø´Ø¯ØŒ Ø§Ø±ÙˆØ± Ø¨Ø¯Ù‡
            }
        }

        async function startExperience() {
            const btn = document.getElementById('start-btn');
            const errBox = document.getElementById('error-msg');
            
            btn.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...";
            btn.disabled = true;
            errBox.style.display = 'none';
            
            try {
                const stream = await getCameraStream();

                videoElement.srcObject = stream;
                videoElement.setAttribute("playsinline", true); 
                await videoElement.play();

                videoTexture = new THREE.VideoTexture(videoElement);
                videoTexture.minFilter = THREE.LinearFilter;
                
                const camera = new Camera(videoElement, {
                    onFrame: async () => { await pose.send({image: videoElement}); },
                    width: 1280, height: 720
                });
                camera.start();

                startOverlay.style.display = 'none';

            } catch (err) {
                console.error(err);
                btn.innerText = "ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯";
                btn.disabled = false;
                errBox.style.display = 'block';
                
                // ØªØ´Ø®ÛŒØµ Ù†ÙˆØ¹ Ø§Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø¨Ù‡ØªØ±
                if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                    errBox.innerHTML = "âŒ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø±Ú¯ÛŒØ± Ø§Ø³Øª!<br>Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± (Ù…Ø«Ù„ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…) Ø±Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¨Ø¨Ù†Ø¯ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.";
                } else if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errBox.innerHTML = "âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯.<br>Ù„Ø·ÙØ§Ù‹ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø±Ø§ Ø¨Ø¯Ù‡ÛŒØ¯.";
                } else {
                    errBox.innerText = "âŒ Ø®Ø·Ø§: " + err.message;
                }
            }
        }

        window.addEventListener('resize', () => {
            camera3d.aspect = window.innerWidth / window.innerHeight;
            camera3d.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        function takePhoto() { alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø³Ú©Ø±ÛŒÙ†â€ŒØ´Ø§Øª Ø¨Ú¯ÛŒØ±ÛŒØ¯ (Ø¯Ú©Ù…Ù‡ Power + Ú©Ù… Ú©Ø±Ø¯Ù† ØµØ¯Ø§)'); }
    </script>
</body>
</html>