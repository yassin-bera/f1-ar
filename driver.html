<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Driver Suit Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #000; font-family: 'Orbitron', sans-serif; overflow: hidden; width: 100vw; height: 100dvh; }

        /* لایه دوربین */
        .input_video { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); display: none; }
        
        /* لایه بوم نقاشی برای لباس */
        .output_canvas { position: absolute; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        /* ماشین در پس‌زمینه (شفاف) */
        model-viewer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;
            background-color: transparent; pointer-events: auto; --poster-color: transparent;
        }

        .ui-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px; z-index: 10;
        }

        .header-glass {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px);
            padding: 15px 20px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.2);
            pointer-events: auto;
        }

        .back-btn {
            background: transparent; color: white; border: 1px solid white; padding: 8px 16px;
            border-radius: 20px; text-decoration: none; font-size: 0.8rem; display: flex; align-items: center; gap: 5px;
        }

        .shutter-btn {
            width: 70px; height: 70px; background: rgba(255,255,255,0.2); border-radius: 50%;
            border: 4px solid white; position: absolute; bottom: 40px; left: 50%;
            transform: translateX(-50%); pointer-events: auto; cursor: pointer; display: flex; justify-content: center; align-items: center;
            z-index: 100;
        }
        .shutter-inner { width: 54px; height: 54px; background: white; border-radius: 50%; transition: 0.1s; }
        .shutter-btn:active .shutter-inner { transform: scale(0.9); background: #ff0040; }

        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #00ff88; font-size: 14px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; z-index: 20; text-align: center;
        }
    </style>
</head>
<body>

    <video class="input_video"></video>
    <canvas class="output_canvas"></canvas>
    <div id="loading">در حال راه‌اندازی دوربین...<br>لطفاً دسترسی را تأیید کنید</div>

    <div class="ui-overlay">
        <div class="header-glass">
            <a href="index.html" class="back-btn">← بازگشت</a>
            <div style="color:#fff; font-weight:bold;">DRIVER SUIT</div>
        </div>

        <div class="shutter-btn" onclick="takePhoto()">
            <div class="shutter-inner"></div>
        </div>
    </div>

    <model-viewer 
        src="https://f1-ar-nine.vercel.app/assets/car.glb"
        alt="F1 Car"
        camera-controls 
        disable-pan
        shadow-intensity="1"
        scale="0.05 0.05 0.05" 
        camera-orbit="45deg 75deg 4m"
        skybox-image="null" 
        environment-image="neutral">
    </model-viewer>

    <script>
        // آدرس عکس آپلود شده شما (مطمئن شوید فایل در کنار driver.html باشد)
        const SUIT_IMAGE_URL = 'image_651907.png'; 
        
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        const canvasCtx = canvasElement.getContext('2d');
        const loadingMsg = document.getElementById('loading');
        let suitImage = new Image();
        
        // هندل کردن لود شدن عکس
        suitImage.src = SUIT_IMAGE_URL;
        suitImage.onload = () => console.log("Suit Image Loaded");
        suitImage.onerror = () => alert("تصویر لباس (image_651907.png) پیدا نشد. لطفا چک کنید فایل در گیت‌هاب کنار فایل html باشد.");

        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults(onResults);

        function onResults(results) {
            loadingMsg.style.display = 'none';
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            if (results.poseLandmarks) {
                const leftShoulder = results.poseLandmarks[11];
                const rightShoulder = results.poseLandmarks[12];
                
                // اگر شانه‌ها دیده شدند
                if(leftShoulder.visibility > 0.5 && rightShoulder.visibility > 0.5) {
                    const shoulderWidth = Math.abs(leftShoulder.x - rightShoulder.x) * canvasElement.width;
                    const centerX = ((leftShoulder.x + rightShoulder.x) / 2) * canvasElement.width;
                    const shoulderY = ((leftShoulder.y + rightShoulder.y) / 2) * canvasElement.height;
                    const angle = Math.atan2(rightShoulder.y - leftShoulder.y, rightShoulder.x - leftShoulder.x);

                    // تنظیم ابعاد لباس
                    const suitWidth = shoulderWidth * 3.2; 
                    const suitHeight = suitWidth * 1.3; 
                    
                    canvasCtx.translate(centerX, shoulderY);
                    canvasCtx.rotate(angle);
                    canvasCtx.drawImage(suitImage, -suitWidth / 2, -suitHeight / 6, suitWidth, suitHeight);
                    canvasCtx.restore();
                }
            }
        }

        const camera = new Camera(videoElement, {
            onFrame: async () => { await pose.send({image: videoElement}); },
            width: 1280, height: 720
        });
        camera.start();

        function takePhoto() {
            const flash = document.createElement('div');
            flash.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:200;transition:opacity 0.5s;";
            document.body.appendChild(flash);
            setTimeout(() => flash.style.opacity = 0, 50);
            setTimeout(() => flash.remove(), 500);
            alert('برای ذخیره، لطفاً اسکرین‌شات بگیرید.');
        }
    </script>
</body>
</html>