<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D Driver Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #000; font-family: 'Orbitron', sans-serif; overflow: hidden; width: 100vw; height: 100dvh; }

        /* ÙˆÛŒØ¯ÛŒÙˆ Ù…Ø®ÙÛŒ (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´) */
        .input_video { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0; z-index: 0; }
        
        /* Ø¨ÙˆÙ… Ø§ØµÙ„ÛŒ Ú©Ù‡ ØªØµÙˆÛŒØ± Ø¯ÙˆØ±Ø¨ÛŒÙ† Ùˆ Ù…Ø¯Ù„ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒØ¯Ù‡Ø¯ */
        #canvas3d { position: absolute; top:0; left:0; width: 100%; height: 100%; z-index: 1; }

        /* Ù…Ø§Ø´ÛŒÙ† Ø¯Ø± Ù„Ø§ÛŒÙ‡ Ø¨Ø§Ù„Ø§ØªØ± */
        model-viewer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5;
            background-color: transparent; pointer-events: auto; --poster-color: transparent;
        }

        .ui-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px; z-index: 10;
        }

        .header-glass {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px);
            padding: 15px 20px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.2);
            pointer-events: auto;
        }

        .back-btn {
            background: transparent; color: white; border: 1px solid white; padding: 8px 16px;
            border-radius: 20px; text-decoration: none; font-size: 0.8rem; display: flex; align-items: center; gap: 5px;
        }

        .shutter-btn {
            width: 70px; height: 70px; background: rgba(255,255,255,0.2); border-radius: 50%;
            border: 4px solid white; position: absolute; bottom: 40px; left: 50%;
            transform: translateX(-50%); pointer-events: auto; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        .shutter-inner { width: 54px; height: 54px; background: white; border-radius: 50%; transition: 0.1s; }
        .shutter-btn:active .shutter-inner { transform: scale(0.9); background: #ff0040; }

        /* Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ±Ø¨ÛŒÙ† (Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Ø³ÛŒØ§Ù‡ Ø¨ÙˆØ¯Ù†) */
        #start-camera-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 50;
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px;
        }
        #start-btn {
            padding: 15px 30px; background: #ff0040; color: white; border: none; border-radius: 30px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px rgba(255, 0, 64, 0.5);
        }
        #error-msg { color: red; font-size: 12px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

    <video class="input_video" playsinline webkit-playsinline></video>
    <canvas id="canvas3d"></canvas>

    <div id="start-camera-overlay">
        <h2 style="color:white;">Ø­Ø§Ù„Øª Ù¾Ø±Ùˆ Ù„Ø¨Ø§Ø³</h2>
        <button id="start-btn" onclick="startExperience()">ğŸ“· Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ†</button>
        <p id="error-msg"></p>
    </div>

    <div class="ui-overlay">
        <div class="header-glass">
            <a href="index.html" class="back-btn">â† Ø¨Ø§Ø²Ú¯Ø´Øª</a>
            <div style="color:#fff; font-weight:bold;">3D SUIT MODE</div>
        </div>
        <div class="shutter-btn" onclick="takePhoto()"><div class="shutter-inner"></div></div>
    </div>

    <model-viewer 
        src="https://f1-ar-nine.vercel.app/assets/car.glb"
        alt="F1 Car"
        camera-controls disable-pan shadow-intensity="1" scale="0.05 0.05 0.05" 
        camera-orbit="45deg 75deg 4m" skybox-image="null" environment-image="neutral">
    </model-viewer>

    <script>
        // Ø¢Ø¯Ø±Ø³ Ù…Ø¯Ù„ Ø³Ù‡ Ø¨Ø¹Ø¯ÛŒ Ú©Ù‡ Ø§Ø² ÙØ§ÛŒÙ„ Ù„ÙˆÚ©Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        const MODEL_URL = 'suit.glb'; 
        
        const videoElement = document.querySelector('.input_video');
        const canvas3d = document.getElementById('canvas3d');
        const startOverlay = document.getElementById('start-camera-overlay');
        const errorMsg = document.getElementById('error-msg');
        
        // --- Three.js Setup ---
        const scene = new THREE.Scene();
        const camera3d = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: canvas3d, alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        
        // Ù†ÙˆØ±
        const light = new THREE.AmbientLight(0xffffff, 1);
        scene.add(light);
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(0, 5, 5);
        scene.add(dirLight);

        let videoTexture; 

        let suitModel = null;
        const loader = new THREE.GLTFLoader();
        
        // Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ suit.glb
        loader.load(MODEL_URL, (gltf) => {
            suitModel = gltf.scene;
            suitModel.scale.set(5, 5, 5);
            suitModel.visible = false;
            scene.add(suitModel);
            console.log("Model Loaded: suit.glb");
        }, undefined, (error) => {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆØ¯ Ù…Ø¯Ù„ suit.glb:", error);
            errorMsg.style.display = 'block';
            errorMsg.innerText = "ÙØ§ÛŒÙ„ suit.glb Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ ÙØ§ÛŒÙ„ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª.";
        });

        camera3d.position.z = 5;

        // --- MediaPipe Setup ---
        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults((results) => {
            if(videoTexture) {
                videoTexture.needsUpdate = true;
                scene.background = videoTexture;
            }

            if (results.poseLandmarks && suitModel) {
                const leftShoulder = results.poseLandmarks[11];
                const rightShoulder = results.poseLandmarks[12];
                
                if(leftShoulder.visibility > 0.5 && rightShoulder.visibility > 0.5) {
                    suitModel.visible = true;

                    const centerX = (leftShoulder.x + rightShoulder.x) / 2;
                    const centerY = (leftShoulder.y + rightShoulder.y) / 2;
                    
                    const x = (1 - centerX) * 2 - 1; 
                    const y = -(centerY * 2 - 1); 
                    
                    suitModel.position.set(x * 4, y * 3, 0); 
                    
                    const dist = Math.sqrt(Math.pow(rightShoulder.x - leftShoulder.x, 2) + Math.pow(rightShoulder.y - leftShoulder.y, 2));
                    const s = dist * 20; 
                    suitModel.scale.set(s, s, s);
                }
            }
            renderer.render(scene, camera3d);
        });

        // --- ØªØ§Ø¨Ø¹ Ø´Ø±ÙˆØ¹ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± ---
        async function startExperience() {
            try {
                document.getElementById('start-btn').innerText = "Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...";
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 1280, height: 720 },
                    audio: false
                });

                videoElement.srcObject = stream;
                videoElement.setAttribute("playsinline", true); 
                await videoElement.play();

                videoTexture = new THREE.VideoTexture(videoElement);
                videoTexture.minFilter = THREE.LinearFilter;
                
                const camera = new Camera(videoElement, {
                    onFrame: async () => { await pose.send({image: videoElement}); },
                    width: 1280, height: 720
                });
                camera.start();

                startOverlay.style.display = 'none';

            } catch (err) {
                console.error(err);
                errorMsg.style.display = 'block';
                errorMsg.innerText = "Ø®Ø·Ø§: Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯.";
                document.getElementById('start-btn').innerText = "ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯";
            }
        }

        window.addEventListener('resize', () => {
            camera3d.aspect = window.innerWidth / window.innerHeight;
            camera3d.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        function takePhoto() { alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø³Ú©Ø±ÛŒÙ†â€ŒØ´Ø§Øª Ø¨Ú¯ÛŒØ±ÛŒØ¯.'); }
    </script>
</body>
</html>