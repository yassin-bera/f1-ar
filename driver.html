<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D Driver Mode (Back Camera)</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #000; font-family: 'Orbitron', sans-serif; overflow: hidden; width: 100vw; height: 100dvh; }

        /* ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø¯ÙˆÙ† Ø­Ø§Ù„Øª Ø¢ÛŒÙ†Ù‡â€ŒØ§ÛŒ (Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ø´Øª) */
        .input_video { 
            position: absolute; width: 100%; height: 100%; 
            object-fit: cover; 
            opacity: 0; z-index: 0; 
        }
        
        #canvas3d { position: absolute; top:0; left:0; width: 100%; height: 100%; z-index: 1; }

        model-viewer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5;
            background-color: transparent; pointer-events: auto; --poster-color: transparent;
        }

        .ui-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px; z-index: 10;
        }

        .header-glass {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px);
            padding: 15px 20px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.2);
            pointer-events: auto;
        }

        .back-btn {
            background: transparent; color: white; border: 1px solid white; padding: 8px 16px;
            border-radius: 20px; text-decoration: none; font-size: 0.8rem; display: flex; align-items: center; gap: 5px;
        }

        .shutter-btn {
            width: 70px; height: 70px; background: rgba(255,255,255,0.2); border-radius: 50%;
            border: 4px solid white; position: absolute; bottom: 40px; left: 50%;
            transform: translateX(-50%); pointer-events: auto; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        .shutter-inner { width: 54px; height: 54px; background: white; border-radius: 50%; transition: 0.1s; }
        .shutter-btn:active .shutter-inner { transform: scale(0.9); background: #ff0040; }

        #start-camera-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 50;
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; text-align: center;
        }
        #start-btn {
            padding: 15px 30px; background: #ff0040; color: white; border: none; border-radius: 30px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px rgba(255, 0, 64, 0.5);
        }
        #status-msg { color: #00ff88; font-size: 14px; margin-top: 20px; max-width: 80%; }
        #error-msg { color: #ff3333; font-size: 14px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

    <video class="input_video" playsinline webkit-playsinline></video>
    <canvas id="canvas3d"></canvas>

    <div id="start-camera-overlay">
        <h2 style="color:white;">Ø­Ø§Ù„Øª Ù¾Ø±Ùˆ Ù„Ø¨Ø§Ø³ (Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø§ØµÙ„ÛŒ)</h2>
        <p style="color:#ccc; font-size: 0.9rem;">Ù„Ø·ÙØ§ ÙØ§ÛŒÙ„ suit.glb Ø±Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´ÛŒØ¯</p>
        <button id="start-btn" onclick="startExperience()">ğŸ“· Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ø´Øª</button>
        <p id="status-msg">Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹...</p>
        <p id="error-msg"></p>
    </div>

    <div class="ui-overlay">
        <div class="header-glass">
            <a href="index.html" class="back-btn">â† Ø¨Ø§Ø²Ú¯Ø´Øª</a>
            <div style="color:#fff; font-weight:bold;">3D SUIT</div>
        </div>
        <div class="shutter-btn" onclick="takePhoto()"><div class="shutter-inner"></div></div>
    </div>

    <model-viewer 
        src="https://f1-ar-nine.vercel.app/assets/car.glb"
        alt="F1 Car"
        camera-controls disable-pan shadow-intensity="1" scale="0.05 0.05 0.05" 
        camera-orbit="45deg 75deg 4m" skybox-image="null" environment-image="neutral">
    </model-viewer>

    <script>
        // Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ù…Ø¯Ù„ Ù„Ø¨Ø§Ø³ (Ø­ØªÙ…Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯ Ú©Ù‡ Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø¯Ø± Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ Ø¨Ø§Ø´Ø¯)
        const MODEL_URL = 'suit.glb'; 
        
        // Ø§Ú¯Ø± Ù„Ø¨Ø§Ø³ Ø®ÛŒÙ„ÛŒ Ú©ÙˆÚ†Ú© ÛŒØ§ Ø¨Ø²Ø±Ú¯ Ø¨ÙˆØ¯ØŒ Ø§ÛŒÙ† Ø¹Ø¯Ø¯ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ (Ù…Ø«Ù„Ø§ 10 ÛŒØ§ 50)
        const BASE_SCALE = 20; 

        const videoElement = document.querySelector('.input_video');
        const canvas3d = document.getElementById('canvas3d');
        const startOverlay = document.getElementById('start-camera-overlay');
        const statusMsg = document.getElementById('status-msg');
        const errorMsg = document.getElementById('error-msg');
        
        // --- Three.js Setup ---
        const scene = new THREE.Scene();
        const camera3d = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: canvas3d, alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        
        // Ù†ÙˆØ± Ù‚ÙˆÛŒâ€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù‡ Ø´Ø¯Ù† Ù…Ø¯Ù„
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(2, 5, 5);
        scene.add(dirLight);

        let videoTexture; 
        let suitModel = null;
        const loader = new THREE.GLTFLoader();
        
        // Ù„ÙˆØ¯ Ù…Ø¯Ù„
        statusMsg.innerText = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…Ø¯Ù„ suit.glb ...";
        loader.load(MODEL_URL, (gltf) => {
            suitModel = gltf.scene;
            suitModel.visible = false;
            scene.add(suitModel);
            console.log("Model Loaded Successfully");
            statusMsg.innerText = "Ù…Ø¯Ù„ Ù„ÙˆØ¯ Ø´Ø¯. Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.";
        }, 
        (xhr) => {
            // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±ØµØ¯ Ù„ÙˆØ¯
            const percent = Math.round((xhr.loaded / xhr.total * 100));
            if(percent < 100) statusMsg.innerText = `Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…Ø¯Ù„: ${percent}%`;
        },
        (error) => {
            console.error(error);
            errorMsg.style.display = 'block';
            errorMsg.innerText = "Ø®Ø·Ø§: ÙØ§ÛŒÙ„ suit.glb Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯! Ù„Ø·ÙØ§ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ ÙØ§ÛŒÙ„ Ø±Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.";
            statusMsg.innerText = "";
        });

        camera3d.position.z = 5;

        // --- MediaPipe Setup ---
        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults((results) => {
            // Ø¢Ù¾Ø¯ÛŒØª Ù¾Ø³ Ø²Ù…ÛŒÙ†Ù‡ ÙˆÛŒØ¯ÛŒÙˆ
            if(videoTexture) {
                videoTexture.needsUpdate = true;
                scene.background = videoTexture;
            }

            if (results.poseLandmarks && suitModel) {
                const leftShoulder = results.poseLandmarks[11];
                const rightShoulder = results.poseLandmarks[12];
                
                // Ø´Ø±Ø· Ø¯ÛŒØ¯Ù‡ Ø´Ø¯Ù† Ø´Ø§Ù†Ù‡â€ŒÙ‡Ø§
                if(leftShoulder.visibility > 0.5 && rightShoulder.visibility > 0.5) {
                    suitModel.visible = true;
                    
                    // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ ÙˆÙ‚ØªÛŒ Ù…Ø¯Ù„ Ù¾ÛŒØ¯Ø§ Ø´Ø¯
                    statusMsg.style.display = 'none';

                    const centerX = (leftShoulder.x + rightShoulder.x) / 2;
                    const centerY = (leftShoulder.y + rightShoulder.y) / 2;
                    
                    // Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ø®ØªØµØ§Øª Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ø´Øª (Ø¨Ø¯ÙˆÙ† Ù‚Ø±ÛŒÙ†Ù‡ Ø³Ø§Ø²ÛŒ)
                    const x = (centerX - 0.5) * 2; // Ù†Ø±Ù…Ø§Ù„ Ø³Ø§Ø²ÛŒ (-1 ØªØ§ 1)
                    const y = -(centerY * 2 - 1);  // Ù…Ø¹Ú©ÙˆØ³ Ú©Ø±Ø¯Ù† Y (Ú†ÙˆÙ† Ø¯Ø± 3D Ø¨Ø§Ù„Ø§ Ù…Ø«Ø¨Øª Ø§Ø³Øª)
                    
                    // ØªÙ†Ø¸ÛŒÙ… Ù…ÙˆÙ‚Ø¹ÛŒØª (Ø¶Ø±Ø§ÛŒØ¨ 4 Ùˆ 3 Ø¨Ø±Ø§ÛŒ Ù¾ÙˆØ´Ø´ Ø¹Ø±Ø¶ ØµÙØ­Ù‡ Ø§Ø³Øª)
                    suitModel.position.set(x * 5, y * 3.5, 0); 
                    
                    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø§ÛŒØ² Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ§ØµÙ„Ù‡ Ø´Ø§Ù†Ù‡â€ŒÙ‡Ø§
                    const dist = Math.sqrt(Math.pow(rightShoulder.x - leftShoulder.x, 2) + Math.pow(rightShoulder.y - leftShoulder.y, 2));
                    const s = dist * BASE_SCALE; 
                    suitModel.scale.set(s, s, s);
                    
                    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú†Ø±Ø®Ø´ (Rotation) Ø¨Ø±Ø§ÛŒ Ú©Ø¬ Ø´Ø¯Ù† Ø¨Ø¯Ù†
                    const angle = Math.atan2(rightShoulder.y - leftShoulder.y, rightShoulder.x - leftShoulder.x);
                    // Ú†Ø±Ø®Ø´ Ø­ÙˆÙ„ Ù…Ø­ÙˆØ± Z (Ú†Ù¾ Ùˆ Ø±Ø§Ø³Øª Ø´Ø¯Ù† Ø´Ø§Ù†Ù‡â€ŒÙ‡Ø§)
                    // Ø¯Ø± Ù…Ø¯ÛŒØ§Ù¾Ø§ÛŒÙ¾ Ø²Ø§ÙˆÛŒÙ‡ Ø¨Ø±Ø¹Ú©Ø³ Ø§Ø³ØªØŒ Ø¨Ø§ Ù…Ù†ÙÛŒ Ø§ØµÙ„Ø§Ø­ Ù…ÛŒÚ©Ù†ÛŒÙ…
                    suitModel.rotation.z = -angle; 
                } else {
                     // Ø§Ú¯Ø± Ø´Ø§Ù†Ù‡â€ŒÙ‡Ø§ Ø¯ÛŒØ¯Ù‡ Ù†Ø´Ø¯Ù†Ø¯ Ù…Ø¯Ù„ Ø±Ø§ Ù…ÙˆÙ‚ØªØ§ Ù…Ø®ÙÛŒ Ú©Ù†
                     // suitModel.visible = false; 
                }
            }
            renderer.render(scene, camera3d);
        });

        async function startExperience() {
            try {
                const btn = document.getElementById('start-btn');
                btn.innerText = "Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†...";
                btn.disabled = true;
                
                // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ø´Øª (environment)
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment', // Ú©Ù„ÛŒØ¯ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ø´Øª
                        width: { ideal: 1280 }, 
                        height: { ideal: 720 } 
                    },
                    audio: false
                });

                videoElement.srcObject = stream;
                videoElement.setAttribute("playsinline", true); 
                await videoElement.play();

                videoTexture = new THREE.VideoTexture(videoElement);
                videoTexture.minFilter = THREE.LinearFilter;
                
                const camera = new Camera(videoElement, {
                    onFrame: async () => { await pose.send({image: videoElement}); },
                    width: 1280, height: 720
                });
                camera.start();

                startOverlay.style.display = 'none';

            } catch (err) {
                console.error(err);
                errorMsg.style.display = 'block';
                errorMsg.innerText = "Ø®Ø·Ø§: Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ø´Øª Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯ ÛŒØ§ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.";
                document.getElementById('start-btn').innerText = "ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯";
                document.getElementById('start-btn').disabled = false;
            }
        }

        window.addEventListener('resize', () => {
            camera3d.aspect = window.innerWidth / window.innerHeight;
            camera3d.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        function takePhoto() { alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø³Ú©Ø±ÛŒÙ†â€ŒØ´Ø§Øª Ø¨Ú¯ÛŒØ±ÛŒØ¯.'); }
    </script>
</body>
</html>